<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Call App</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <style>
    :root {
      --primary: #4f46e5;
      --danger: #dc2626;
      --success: #16a34a;
      --bg-light: #f9fafb;
      --bg-dark: #111827;
      --text-light: #111827;
      --text-dark: #f9fafb;
    }

    body { margin:0; font-family:system-ui,sans-serif; display:flex; align-items:center; justify-content:center; min-height:100vh; background:var(--bg-light); color:var(--text-light); transition:0.3s; }
    body.dark { background:var(--bg-dark); color:var(--text-dark); }

    .card { width:100%; max-width:400px; background:white; padding:2rem; border-radius:1.25rem; box-shadow:0 8px 20px rgba(0,0,0,0.2); text-align:center; transition:0.3s; }
    body.dark .card { background:#1f2937; }

    h1 { margin-bottom:1rem; font-size:1.5rem; }

    input { width:100%; padding:0.6rem; margin:0.5rem 0; border:1px solid #d1d5db; border-radius:0.5rem; font-size:1rem; }

    button { display:inline-block; margin:0.3rem; padding:0.7rem 1.2rem; font-size:1rem; border:none; border-radius:0.6rem; cursor:pointer; transition:0.1s,0.2s; }
    button:hover { transform: scale(1.05); }

    .btn-primary { background:var(--primary); color:white; }
    .btn-danger { background:var(--danger); color:white; }
    .btn-success { background:var(--success); color:white; }
    .btn-secondary { background:#6b7280; color:white; }

    #status { margin-top:1rem; font-style:italic; }

    .hidden { display:none; }
    .theme-switch { margin-top:1rem; }

    #instructions { font-size:1rem; line-height:1.5; text-align:left; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Voice Call App</h1>

    <!-- Instructions for browser -->
    <div id="instructions" class="hidden">
      <p>üì≤ To use this app, you need to install it on your device:</p>
      <ol>
        <li>Tap your browser menu (‚ãÆ) ‚Üí "Add to Home Screen"</li>
        <li>Open the app from your Home Screen</li>
        <li>Allow microphone and notifications when prompted</li>
      </ol>
    </div>

    <!-- App content -->
    <div id="appContent" class="hidden">
      <!-- Home Screen -->
      <div id="menu">
        <p>Your number: <b id="myNumber">...</b></p>
        <input id="callInput" placeholder="Enter number to call" />
        <button class="btn-primary" id="callBtn">üìû Call</button>
      </div>

      <!-- Incoming Call -->
      <div id="incoming" class="hidden">
        <p>Incoming call from <b id="callerNumber"></b></p>
        <button class="btn-success" id="acceptBtn">‚úÖ Accept</button>
        <button class="btn-danger" id="denyBtn">‚ùå Deny</button>
      </div>

      <!-- Call Screen -->
      <div id="call" class="hidden">
        <p>In call with <b id="peerNumber"></b></p>
        <button class="btn-secondary" id="muteBtn">üîá Mute</button>
        <button class="btn-danger" id="endBtn">üîö End</button>
      </div>

      <p id="status">Idle</p>
      <div class="theme-switch">
        <button id="toggleTheme" class="btn-secondary">üåô Toggle Theme</button>
      </div>

      <audio id="remoteAudio" autoplay></audio>
    </div>
  </div>

  <script type="module">
    // --------------------------
    // Standalone detection
    // --------------------------
    function checkStandalone() {
      const instructions = document.getElementById("instructions");
      const appContent = document.getElementById("appContent");

      requestAnimationFrame(() => {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                             window.navigator.standalone === true;

        if(!isStandalone){
          instructions.classList.remove("hidden");
          appContent.classList.add("hidden");
        } else {
          instructions.classList.add("hidden");
          appContent.classList.remove("hidden");
          initApp();
        }
      });
    }
    window.addEventListener('load', checkStandalone);

    // Optional install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const instructions = document.getElementById("instructions");
      instructions.classList.remove("hidden");
      instructions.addEventListener('click', async () => {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        instructions.classList.add("hidden");
      });
    });

    // --------------------------
    // Full App Logic
    // --------------------------
    function initApp() {
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
      import { getDatabase, ref, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
      import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-messaging.js";

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyCzfjcgM1LDpdplvnZ70TZMwiCdfJBaCSI",
        authDomain: "voice-call-bef3b.firebaseapp.com",
        databaseURL: "https://voice-call-bef3b-default-rtdb.firebaseio.com",
        projectId: "voice-call-bef3b",
        storageBucket: "voice-call-bef3b.firebasestorage.app",
        messagingSenderId: "280467966695",
        appId: "1:280467966695:web:1cfdc7f7bcef6a677db042"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const messaging = getMessaging(app);

      // Request notifications
      async function initNotifications(){
        if('Notification' in window && Notification.permission!=="granted"){
          const perm = await Notification.requestPermission();
          if(perm!=="granted"){ console.log("Notifications denied"); return; }
        }
        try{
          const token = await getToken(messaging,{
            vapidKey:"BGUWOlVW7JNJ3O29gtajLywP7mNb6qv7eEcJMXcCZj_Vwd_rDURycsaFe_fRYjnKkPomYdv8AUFjSDbIbkOlWvs"
          });
          console.log("FCM Token:",token);
        } catch(e){ console.error(e); }
      }
      initNotifications();

      // --- Elements ---
      const myNumberEl = document.getElementById("myNumber");
      const callInput = document.getElementById("callInput");
      const callBtn = document.getElementById("callBtn");
      const incoming = document.getElementById("incoming");
      const callerNumberEl = document.getElementById("callerNumber");
      const acceptBtn = document.getElementById("acceptBtn");
      const denyBtn = document.getElementById("denyBtn");
      const callDiv = document.getElementById("call");
      const peerNumberEl = document.getElementById("peerNumber");
      const muteBtn = document.getElementById("muteBtn");
      const endBtn = document.getElementById("endBtn");
      const statusEl = document.getElementById("status");
      const toggleTheme = document.getElementById("toggleTheme");
      const remoteAudio = document.getElementById("remoteAudio");

      let pc, localStream, remoteStream;
      let myNumber, remoteNumber, callPath;

      // --- Helpers ---
      function show(id){
        document.getElementById("menu")?.classList.add("hidden");
        incoming.classList.add("hidden");
        callDiv.classList.add("hidden");
        document.getElementById(id)?.classList.remove("hidden");
      }

      function updateStatus(msg){ statusEl.textContent = msg; }

      function getMyNumber(){
        let num = localStorage.getItem("myNumber");
        if(!num){ num = Math.floor(10000+Math.random()*90000).toString(); localStorage.setItem("myNumber",num); }
        return num;
      }

      myNumber = getMyNumber();
      myNumberEl.textContent = myNumber;

      toggleTheme.onclick=()=>document.body.classList.toggle("dark");

      // --------------------------
      // Call setup, buttons, Firebase listeners
      // Copy your previous setupConnection and button logic here
      // --------------------------
    }
  </script>
</body>
</html>
