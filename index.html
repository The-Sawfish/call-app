<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“ž Voice Call App</title>
  <style>
    body { font-family: Arial; text-align: center; background: #f5f5f5; }
    h1 { margin-top: 20px; }
    .screen { display: none; margin-top: 20px; }
    input, button { padding: 10px; margin: 5px; font-size: 16px; border-radius: 5px; }
    button { cursor: pointer; background: #007bff; color: white; border: none; }
    button:hover { background: #0056b3; }
    .danger { background: red; }
    .secondary { background: gray; }
  </style>
</head>
<body>
  <h1>ðŸ“ž Voice Call App</h1>
  <p>Your Number: <span id="myNumber"></span></p>
  <p>Status: <span id="status">Idle</span></p>

  <!-- Call Menu -->
  <div id="menuScreen" class="screen">
    <input id="callNumberInput" placeholder="Enter number to call">
    <button id="callBtn">Call</button>
  </div>

  <!-- Incoming Call -->
  <div id="incomingScreen" class="screen">
    <p>Incoming call from: <span id="callerNumber"></span></p>
    <button id="acceptBtn">Accept</button>
    <button id="denyBtn" class="danger">Deny</button>
  </div>

  <!-- In Call -->
  <div id="callScreen" class="screen">
    <p>In call with: <span id="remoteNumber"></span></p>
    <button id="endBtn" class="danger">End Call</button>
    <button id="muteBtn" class="secondary">Mute</button>
    <audio id="localAudio" autoplay muted></audio>
    <audio id="remoteAudio" autoplay></audio>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getDatabase, ref, set, push, onValue, onChildAdded, remove, get, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCzfjcgM1LDpdplvnZ70TZMwiCdfJBaCSI",
      authDomain: "voice-call-bef3b.firebaseapp.com",
      databaseURL: "https://voice-call-bef3b-default-rtdb.firebaseio.com",
      projectId: "voice-call-bef3b",
      storageBucket: "voice-call-bef3b.firebasestorage.app",
      messagingSenderId: "280467966695",
      appId: "1:280467966695:web:1cfdc7f7bcef6a677db042",
      measurementId: "G-P1MEWVE8SN"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // --- State ---
    let myNumber = localStorage.getItem("myNumber") || Math.floor(10000 + Math.random()*90000).toString();
    localStorage.setItem("myNumber", myNumber);

    let pc, localStream, remoteNumber, callPath;
    let isMuted = false;

    // --- Elements ---
    const menuScreen = document.getElementById("menuScreen");
    const incomingScreen = document.getElementById("incomingScreen");
    const callScreen = document.getElementById("callScreen");

    const callNumberInput = document.getElementById("callNumberInput");
    const callBtn = document.getElementById("callBtn");

    const callerNumberEl = document.getElementById("callerNumber");
    const acceptBtn = document.getElementById("acceptBtn");
    const denyBtn = document.getElementById("denyBtn");

    const remoteNumberEl = document.getElementById("remoteNumber");
    const endBtn = document.getElementById("endBtn");
    const muteBtn = document.getElementById("muteBtn");

    const statusEl = document.getElementById("status");
    const localAudio = document.getElementById("localAudio");
    const remoteAudio = document.getElementById("remoteAudio");

    document.getElementById("myNumber").innerText = myNumber;

    function show(screen){
      menuScreen.style.display = (screen==="menu")?"block":"none";
      incomingScreen.style.display = (screen==="incoming")?"block":"none";
      callScreen.style.display = (screen==="call")?"block":"none";
    }
    function updateStatus(msg){ statusEl.innerText = msg; }
    show("menu");

    const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    // -----------------------
    // Start call
    // -----------------------
    callBtn.onclick = async () => {
      const toNumber = callNumberInput.value.trim();
      if(toNumber.length!==5 || toNumber===myNumber) return alert("Invalid number");

      remoteNumber = toNumber;
      callPath = `calls/${myNumber}_${remoteNumber}`;

      // Mark call as ringing
      await set(ref(db, callPath), { from: myNumber, to: remoteNumber, status: "ringing" });

      await setupConnection(false);
      show("call");
      updateStatus("Calling...");
    };

    // -----------------------
    // Listen for incoming calls
    // -----------------------
    onValue(ref(db, "calls"), snapshot => {
      const calls = snapshot.val() || {};
      for(const key in calls){
        const call = calls[key];
        if(call.to===myNumber && call.status==="ringing"){
          remoteNumber = call.from;
          callPath = `calls/${remoteNumber}_${myNumber}`;
          callerNumberEl.innerText = remoteNumber;
          show("incoming");
          updateStatus("Incoming call");
          break;
        }
      }
    });

    // -----------------------
    // Accept / Deny
    // -----------------------
    acceptBtn.onclick = async () => {
      await update(ref(db, callPath), { status: "in-progress" });
      await setupConnection(true);
      show("call");
      updateStatus("In Call ðŸŽ¤");
    };

    denyBtn.onclick = async () => {
      await remove(ref(db, callPath));
      show("menu");
      updateStatus("Idle");
    };

    // -----------------------
    // WebRTC Setup
    // -----------------------
    async function setupConnection(isAnswer){
      pc = new RTCPeerConnection(servers);

      // Local audio
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      localAudio.srcObject = localStream;

      // Remote audio
      pc.ontrack = (event)=>{ remoteAudio.srcObject = event.streams[0]; };

      // ICE
      pc.onicecandidate = (e)=>{
        if(e.candidate){
          push(ref(db, `${callPath}/candidates/${isAnswer?"answer":"offer"}`), e.candidate.toJSON());
        }
      };

      if(!isAnswer){
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await set(ref(db, `${callPath}/offer`), offer.toJSON());

        // Wait for answer
        onValue(ref(db, `${callPath}/answer`), async snap=>{
          const ans = snap.val();
          if(ans && !pc.currentRemoteDescription){
            await pc.setRemoteDescription(new RTCSessionDescription(ans));
          }
        });

      } else {
        const offerSnap = await get(ref(db, `${callPath}/offer`));
        const offer = offerSnap.val();
        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await set(ref(db, `${callPath}/answer`), answer.toJSON());
      }

      // Candidate exchange
      onChildAdded(ref(db, `${callPath}/candidates/${isAnswer?"offer":"answer"}`), snap=>{
        pc.addIceCandidate(new RTCIceCandidate(snap.val()));
      });

      remoteNumberEl.innerText = remoteNumber;
    }

    // -----------------------
    // End / Mute
    // -----------------------
    endBtn.onclick = async () => {
      if(pc) pc.close();
      if(localStream) localStream.getTracks().forEach(t=>t.stop());
      if(callPath) await remove(ref(db, callPath));
      pc=null; callPath=null;
      show("menu");
      updateStatus("Idle");
    };

    muteBtn.onclick = () => {
      if(!localStream) return;
      const track = localStream.getAudioTracks()[0];
      track.enabled = !track.enabled;
      muteBtn.innerText = track.enabled?"Mute":"Unmute";
    };
  </script>
</body>
</html>
