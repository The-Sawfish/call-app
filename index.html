<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Voice Call App</title>
  <style>
    :root {
      --primary: #4f46e5;
      --danger: #dc2626;
      --success: #16a34a;
      --bg-light: #f9fafb;
      --bg-dark: #111827;
      --text-light: #111827;
      --text-dark: #f9fafb;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--bg-light);
      color: var(--text-light);
      transition: all 0.3s;
    }

    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    .card {
      width: 100%;
      max-width: 400px;
      background: white;
      padding: 2rem;
      border-radius: 1.25rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      text-align: center;
      transition: background 0.3s;
    }

    body.dark .card {
      background: #1f2937;
    }

    h1 {
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    input {
      width: 100%;
      padding: 0.6rem;
      margin: 0.5rem 0;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    button {
      display: inline-block;
      margin: 0.3rem;
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      border: none;
      border-radius: 0.6rem;
      cursor: pointer;
      transition: transform 0.1s, background 0.2s;
    }

    button:hover { transform: scale(1.05); }

    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-secondary { background: #6b7280; color: white; }

    #status { margin-top: 1rem; font-style: italic; }

    .hidden { display: none; }
    .theme-switch { margin-top: 1rem; }

    /* Notifications panel */
    #notifications {
      margin-top: 1rem;
      text-align: left;
      font-size: 0.9rem;
      max-height: 120px;
      overflow-y: auto;
    }
    .note {
      background: #e5e7eb;
      padding: 0.5rem;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }
    body.dark .note {
      background: #374151;
      color: #f9fafb;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Voice Call</h1>

    <!-- Home Screen -->
    <div id="menu">
      <p>Your number: <b id="myNumber">...</b></p>
      <input id="callInput" placeholder="Enter number to call" />
      <button class="btn-primary" id="callBtn">üìû Call</button>
    </div>

    <!-- Incoming Call -->
    <div id="incoming" class="hidden">
      <p>Incoming call from <b id="callerNumber"></b></p>
      <button class="btn-success" id="acceptBtn">‚úÖ Accept</button>
      <button class="btn-danger" id="denyBtn">‚ùå Deny</button>
    </div>

    <!-- Call Screen -->
    <div id="call" class="hidden">
      <p>In call with <b id="peerNumber"></b></p>
      <button class="btn-secondary" id="muteBtn">üîá Mute</button>
      <button class="btn-danger" id="endBtn">üîö End</button>
    </div>

    <p id="status">Idle</p>
    <div id="notifications"></div>

    <div class="theme-switch">
      <button id="toggleTheme" class="btn-secondary">üåô Toggle Theme</button>
    </div>
  </div>

  <audio id="remoteAudio" autoplay></audio>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzfjcgM1LDpdplvnZ70TZMwiCdfJBaCSI",
      authDomain: "voice-call-bef3b.firebaseapp.com",
      databaseURL: "https://voice-call-bef3b-default-rtdb.firebaseio.com",
      projectId: "voice-call-bef3b",
      storageBucket: "voice-call-bef3b.firebasestorage.app",
      messagingSenderId: "280467966695",
      appId: "1:280467966695:web:1cfdc7f7bcef6a677db042",
      measurementId: "G-P1MEWVE8SN"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const myNumberEl = document.getElementById("myNumber");
    const callerNumberEl = document.getElementById("callerNumber");
    const callInput = document.getElementById("callInput");
    const callBtn = document.getElementById("callBtn");
    const acceptBtn = document.getElementById("acceptBtn");
    const denyBtn = document.getElementById("denyBtn");
    const callDiv = document.getElementById("call");
    const peerNumberEl = document.getElementById("peerNumber");
    const muteBtn = document.getElementById("muteBtn");
    const endBtn = document.getElementById("endBtn");
    const statusEl = document.getElementById("status");
    const toggleTheme = document.getElementById("toggleTheme");
    const notificationsEl = document.getElementById("notifications");

    let pc, localStream, remoteStream;
    let myNumber, remoteNumber, callPath;

    function show(id) {
      document.getElementById("menu").classList.add("hidden");
      document.getElementById("incoming").classList.add("hidden");
      callDiv.classList.add("hidden");
      document.getElementById(id).classList.remove("hidden");
    }
    function updateStatus(msg) { statusEl.textContent = msg; }

    function getMyNumber() {
      let num = localStorage.getItem("myNumber");
      if (!num) {
        num = Math.floor(10000 + Math.random() * 90000).toString();
        localStorage.setItem("myNumber", num);
      }
      return num;
    }

    function addNotification(msg) {
      const note = document.createElement("div");
      note.className = "note";
      note.textContent = msg;
      notificationsEl.prepend(note);
    }

    // Browser Notification permission
    if ("Notification" in window) {
      Notification.requestPermission();
    }
    function sendBrowserNotification(msg) {
      if (Notification.permission === "granted") {
        new Notification("Voice Call App", { body: msg });
      }
    }

    myNumber = getMyNumber();
    myNumberEl.textContent = myNumber;

    toggleTheme.onclick = () => document.body.classList.toggle("dark");

    // --- Incoming call listener ---
    onValue(ref(db, "calls"), snap => {
      const calls = snap.val() || {};
      for (const key in calls) {
        const call = calls[key];
        if (call.to === myNumber && call.status === "ringing") {
          remoteNumber = call.from;
          callPath = `calls/${remoteNumber}_${myNumber}`;
          callerNumberEl.textContent = remoteNumber;
          show("incoming");
          updateStatus("Incoming Call...");
          addNotification(`Incoming call from ${remoteNumber}`);
          sendBrowserNotification(`Incoming call from ${remoteNumber}`);
        }
        if (call.to === myNumber && call.status === "ended") {
          show("menu");
          updateStatus("Caller hung up.");
          addNotification(`Missed call from ${call.from}`);
          sendBrowserNotification(`Missed call from ${call.from}`);
        }
      }
    });
  </script>
</body>
</html>
