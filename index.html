<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Call App</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">

<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
body {
  margin:0;
  font-family:system-ui,sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  background:#f9fafb;
  color:#111827;
}
body.dark { background:#111827; color:#f9fafb; }

.card {
  width:100%;
  max-width:400px;
  padding:2rem;
  border-radius:1.25rem;
  background:white;
  box-shadow:0 8px 20px rgba(0,0,0,0.2);
  text-align:center;
}
body.dark .card { background:#1f2937; }

.hidden { display:none; }

.overlay {
  position:fixed;
  inset:0;
  background:rgba(249,250,251,0.95);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:9999;
  text-align:center;
  padding:2rem;
}

input { width:100%; padding:0.6rem; margin:0.5rem 0; border-radius:0.5rem; border:1px solid #d1d5db; }
button { margin:0.3rem; padding:0.7rem 1.2rem; border:none; border-radius:0.6rem; cursor:pointer; }
.btn-primary { background:#4f46e5; color:white; }
.btn-danger { background:#dc2626; color:white; }
.btn-success { background:#16a34a; color:white; }
.btn-secondary { background:#6b7280; color:white; }
</style>
</head>

<body>

<!-- INSTALL OVERLAY -->
<div id="installOverlay" class="overlay">
  <h1>Voice Call App</h1>
  <p>ðŸ“² Install this app to continue:</p>
  <ol>
    <li>Open browser menu</li>
    <li>Select <b>Add to Home Screen</b></li>
    <li>Open from Home Screen</li>
  </ol>
</div>

<!-- APP UI -->
<section id="appUI" class="card hidden">

  <div id="menu">
    <p>Your number: <b id="myNumber"></b></p>
    <input id="callInput" placeholder="Enter number to call" />
    <button class="btn-primary" id="callBtn">ðŸ“ž Call</button>
  </div>

  <div id="incoming" class="hidden">
    <p>Incoming call from <b id="callerNumber"></b></p>
    <button class="btn-success" id="acceptBtn">Accept</button>
    <button class="btn-danger" id="denyBtn">Deny</button>
  </div>

  <div id="call" class="hidden">
    <p>In call with <b id="peerNumber"></b></p>
    <button class="btn-secondary" id="muteBtn">Mute</button>
    <button class="btn-danger" id="endBtn">End</button>
  </div>

  <p id="status">Idle</p>
  <button class="btn-secondary" id="toggleTheme">Toggle Theme</button>
  <audio id="remoteAudio" autoplay></audio>
</section>

<script type="module">
let swReg = null;
let initialized = false;

if ("serviceWorker" in navigator) {
  swReg = await navigator.serviceWorker.register("/call-app/sw.js", { scope: "/call-app/" });
}

function isPWA() {
  return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
}

async function checkMode() {
  await new Promise(r => setTimeout(r, 50));
  const overlay = document.getElementById("installOverlay");
  const appUI = document.getElementById("appUI");

  if (isPWA()) {
    overlay.classList.add("hidden");
    appUI.classList.remove("hidden");
    if (!initialized) initApp();
  } else {
    appUI.classList.add("hidden");
    overlay.classList.remove("hidden");
  }
}

window.addEventListener("load", checkMode);
window.addEventListener("appinstalled", checkMode);
document.addEventListener("visibilitychange", () => !document.hidden && checkMode());

async function initApp() {
  initialized = true;

  const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js");
  const { getDatabase, ref, set, update, remove, onValue } =
    await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js");
  const { getMessaging, getToken } =
    await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-messaging.js");

  const firebaseConfig = {
    apiKey: "AIzaSyCzfjcgM1LDpdplvnZ70TZMwiCdfJBaCSI",
    authDomain: "voice-call-bef3b.firebaseapp.com",
    databaseURL: "https://voice-call-bef3b-default-rtdb.firebaseio.com",
    projectId: "voice-call-bef3b",
    storageBucket: "voice-call-bef3b.firebasestorage.app",
    messagingSenderId: "280467966695",
    appId: "1:280467966695:web:1cfdc7f7bcef6a677db042"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const messaging = getMessaging(app);

  if (Notification.permission !== "granted") {
    await Notification.requestPermission();
  }

  await getToken(messaging, {
    vapidKey: "BGUWOlVW7JNJ3O29gtajLywP7mNb6qv7eEcJMXcCZj_Vwd_rDURycsaFe_fRYjnKkPomYdv8AUFjSDbIbkOlWvs",
    serviceWorkerRegistration: swReg
  });

  const myNumberEl = document.getElementById("myNumber");
  const callBtn = document.getElementById("callBtn");
  const callInput = document.getElementById("callInput");
  const statusEl = document.getElementById("status");
  const toggleTheme = document.getElementById("toggleTheme");

  let myNumber = localStorage.getItem("myNumber") || Math.floor(10000 + Math.random()*90000);
  localStorage.setItem("myNumber", myNumber);
  myNumberEl.textContent = myNumber;

  toggleTheme.onclick = () => document.body.classList.toggle("dark");

  callBtn.onclick = () => {
    statusEl.textContent = "Calling " + callInput.value;
  };

  statusEl.textContent = "Ready";
}
</script>
</body>
</html>
