<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“ž Voice Call App</title>
  <style>
    body { font-family: Arial; text-align: center; background: #f5f5f5; }
    h1 { margin-top: 20px; }
    .screen { display: none; margin-top: 20px; }
    input, button { padding: 10px; margin: 5px; font-size: 16px; border-radius: 5px; }
    button { cursor: pointer; background: #007bff; color: white; border: none; }
    button:hover { background: #0056b3; }
    audio { display: none; }
  </style>
</head>
<body>
  <h1>ðŸ“ž Voice Call App</h1>
  <p>Your Number: <span id="myNumber"></span></p>
  <p>Status: <span id="status">Idle</span></p>

  <!-- Call Menu -->
  <div id="menuScreen" class="screen">
    <input id="callNumberInput" placeholder="Enter number to call">
    <button id="callBtn">Call</button>
  </div>

  <!-- Incoming Call -->
  <div id="incomingScreen" class="screen">
    <p>Incoming call from: <span id="callerNumber"></span></p>
    <button id="acceptBtn">Accept</button>
    <button id="denyBtn">Deny</button>
  </div>

  <!-- In Call -->
  <div id="callScreen" class="screen">
    <p>In call with: <span id="remoteNumber"></span></p>
    <button id="endBtn">End Call</button>
    <button id="muteBtn">Mute</button>
    <audio id="localAudio" autoplay muted></audio>
    <audio id="remoteAudio" autoplay></audio>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getDatabase, ref, set, push, onValue, onChildAdded, remove, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzfjcgM1LDpdplvnZ70TZMwiCdfJBaCSI",
      authDomain: "voice-call-bef3b.firebaseapp.com",
      databaseURL: "https://voice-call-bef3b-default-rtdb.firebaseio.com",
      projectId: "voice-call-bef3b",
      storageBucket: "voice-call-bef3b.firebasestorage.app",
      messagingSenderId: "280467966695",
      appId: "1:280467966695:web:1cfdc7f7bcef6a677db042",
      measurementId: "G-P1MEWVE8SN"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // -----------------------
    // State & Elements
    // -----------------------
    let myNumber = localStorage.getItem("myNumber") || Math.floor(10000 + Math.random()*90000).toString();
    localStorage.setItem("myNumber", myNumber);

    const menuScreen = document.getElementById("menuScreen");
    const incomingScreen = document.getElementById("incomingScreen");
    const callScreen = document.getElementById("callScreen");

    const callNumberInput = document.getElementById("callNumberInput");
    const callBtn = document.getElementById("callBtn");

    const callerNumberEl = document.getElementById("callerNumber");
    const acceptBtn = document.getElementById("acceptBtn");
    const denyBtn = document.getElementById("denyBtn");

    const remoteNumberEl = document.getElementById("remoteNumber");
    const endBtn = document.getElementById("endBtn");
    const muteBtn = document.getElementById("muteBtn");

    const statusEl = document.getElementById("status");
    const localAudio = document.getElementById("localAudio");
    const remoteAudio = document.getElementById("remoteAudio");

    document.getElementById("myNumber").innerText = myNumber;

    let pc, localStream, remoteNumber, callRef;
    let isMuted = false;

    function show(screen) {
      menuScreen.style.display = screen === "menu" ? "block" : "none";
      incomingScreen.style.display = screen === "incoming" ? "block" : "none";
      callScreen.style.display = screen === "call" ? "block" : "none";
    }

    function updateStatus(msg) { statusEl.innerText = msg; }

    show("menu");

    const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    // -----------------------
    // Listen for incoming calls
    // -----------------------
    const callsRef = ref(db, "calls");
    onChildAdded(callsRef, snapshot => {
      const call = snapshot.val();
      const callId = snapshot.key;
      if(call.to === myNumber && !pc){
        // Incoming call
        remoteNumber = call.from;
        callerNumberEl.innerText = remoteNumber;
        show("incoming");
        callRef = ref(db, `calls/${callId}`);
      }
    });

    // -----------------------
    // Accept / Deny buttons
    // -----------------------
    acceptBtn.onclick = async () => {
      await setupCall(remoteNumber, true);
      show("call");
    };

    denyBtn.onclick = async () => {
      remove(callRef);
      show("menu");
    };

    // -----------------------
    // Make a call
    // -----------------------
    callBtn.onclick = async () => {
      const toNumber = callNumberInput.value.trim();
      if(toNumber.length!==5) return alert("Enter a valid 5-digit number");

      remoteNumber = toNumber;

      // Create call object
      const newCallRef = push(ref(db, "calls"));
      await set(newCallRef, { from: myNumber, to: toNumber });

      callRef = newCallRef;

      await setupCall(toNumber, false);
      show("call");
    };

    // -----------------------
    // Setup WebRTC call
    // -----------------------
    async function setupCall(remoteNum, isAnswer) {
      pc = new RTCPeerConnection(servers);

      // Local audio
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      localAudio.srcObject = localStream;

      // Remote audio
      pc.ontrack = (event) => { remoteAudio.srcObject = event.streams[0]; };

      // ICE candidates
      pc.onicecandidate = (event) => {
        if(event.candidate){
          push(ref(db, `calls/${myNumber}_${remoteNum}/candidates`), event.candidate.toJSON());
        }
      };

      // Listen for remote candidates
      const candidatesRef = ref(db, `calls/${remoteNum}_${myNumber}/candidates`);
      onChildAdded(candidatesRef, snapshot => {
        pc.addIceCandidate(new RTCIceCandidate(snapshot.val()));
      });

      // Create offer or answer
      if(!isAnswer){
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await set(ref(db, `calls/${myNumber}_${remoteNum}/offer`), offer.toJSON());

        // Listen for answer
        onValue(ref(db, `calls/${remoteNum}_${myNumber}/answer`), async snap=>{
          const ans = snap.val();
          if(ans && !pc.currentRemoteDescription){
            await pc.setRemoteDescription(new RTCSessionDescription(ans));
          }
        });
      } else {
        // Get offer
        const offerSnap = await get(ref(db, `calls/${remoteNum}_${myNumber}/offer`));
        const offer = offerSnap.val();
        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        // Create answer
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await set(ref(db, `calls/${myNumber}_${remoteNum}/answer`), answer.toJSON());
      }
      remoteNumberEl.innerText = remoteNum;
      updateStatus("In call ðŸŽ¤");
    }

    // -----------------------
    // End call
    // -----------------------
    endBtn.onclick = () => {
      if(pc) pc.close();
      if(localStream) localStream.getTracks().forEach(t=>t.stop());
      if(callRef) remove(callRef);
      pc = null;
      callRef = null;
      show("menu");
      updateStatus("Idle");
    };

    // -----------------------
    // Mute
    // -----------------------
    muteBtn.onclick = () => {
      if(!localStream) return;
      const track = localStream.getAudioTracks()[0];
      track.enabled = !track.enabled;
      muteBtn.innerText = track.enabled?"Mute":"Unmute";
    };
  </script>
</body>
</html>
